# Weather Tracing PoC - Product Requirements Document (PRD)

## 1. 專案概述

### 1.1 專案名稱
**Weather Tracing PoC** - 天氣查詢可觀測性展示系統

### 1.2 專案目標
建立一個簡單的天氣查詢系統，**核心目的是展示分散式系統的可觀測性能力**，包含：
- 完整的請求鏈路追蹤（Distributed Tracing）
- 系統指標監控（Metrics Monitoring）
- 從前端到資料庫的端到端追蹤可視化

### 1.3 專案範圍
| 範圍內 | 範圍外 |
|--------|--------|
| 三個城市的天氣查詢 | 真實天氣 API 整合 |
| 模擬天氣資料（溫度、雨量） | 使用者認證/授權 |
| 完整鏈路追蹤展示 | 天氣預報功能 |
| 多種部署模式支援 | 多租戶支援 |

---

## 2. 使用者故事

### 2.1 主要使用者
- **角色**：系統展示觀眾 / 開發團隊成員
- **目標**：理解分散式追蹤如何運作，觀察請求在微服務間的流轉

### 2.2 使用者故事清單

#### US-001: 查詢城市天氣
```
作為一個使用者
我希望能夠選擇一個城市（台北/台中/高雄）
以便查看該城市的當前天氣資訊（氣溫、雨量）
```

**驗收條件：**
- [ ] 頁面顯示三個城市按鈕：台北、台中、高雄
- [ ] 點擊任一城市後，顯示該城市的氣溫（°C）和雨量（mm）
- [ ] 顯示載入中狀態
- [ ] 錯誤時顯示友善錯誤訊息

#### US-002: 查看請求追蹤資訊
```
作為一個開發者/展示觀眾
我希望能在頁面上看到當前請求的 Trace ID
以便在 Jaeger UI 中追蹤完整請求鏈路
```

**驗收條件：**
- [ ] 每次查詢後，頁面顯示對應的 Trace ID
- [ ] Trace ID 可點擊，直接跳轉至 Jaeger UI 查看詳情
- [ ] 顯示請求的總耗時

#### US-003: 觀察系統指標
```
作為一個開發者/維運人員
我希望能透過 Grafana 儀表板查看系統指標
以便了解系統的健康狀態和效能表現
```

**驗收條件：**
- [ ] Grafana 顯示請求數量（QPS）
- [ ] Grafana 顯示請求延遲分布
- [ ] Grafana 顯示錯誤率
- [ ] 可依服務篩選指標

---

## 3. 功能規格

### 3.1 天氣查詢功能

#### 3.1.1 支援城市
| 城市代碼 | 城市名稱 | 英文名稱 |
|----------|----------|----------|
| TPE | 台北 | Taipei |
| TXG | 台中 | Taichung |
| KHH | 高雄 | Kaohsiung |

#### 3.1.2 天氣資料欄位
| 欄位 | 型別 | 說明 | 範例 |
|------|------|------|------|
| cityCode | String | 城市代碼 | TPE |
| cityName | String | 城市名稱 | 台北 |
| temperature | Double | 氣溫（攝氏） | 28.5 |
| rainfall | Double | 雨量（毫米） | 12.3 |
| updatedAt | DateTime | 資料更新時間 | 2025-01-20T10:30:00Z |

#### 3.1.3 模擬資料規則
為展示不同情境，模擬資料應有變化：
- 溫度範圍：15°C ~ 35°C（依城市有基準差異）
- 雨量範圍：0mm ~ 50mm
- 每次查詢加入隨機變化（±2°C, ±5mm）

**城市基準溫度：**
| 城市 | 基準溫度 | 基準雨量 |
|------|----------|----------|
| 台北 | 25°C | 15mm |
| 台中 | 27°C | 10mm |
| 高雄 | 29°C | 8mm |

### 3.2 前端介面規格

#### 3.2.1 頁面佈局
```
┌─────────────────────────────────────────────────────┐
│                 🌤️ 天氣查詢系統                      │
│              Weather Tracing PoC                    │
├─────────────────────────────────────────────────────┤
│                                                     │
│    ┌─────────┐  ┌─────────┐  ┌─────────┐          │
│    │  台北   │  │  台中   │  │  高雄   │          │
│    │  TPE    │  │  TXG    │  │  KHH    │          │
│    └─────────┘  └─────────┘  └─────────┘          │
│                                                     │
├─────────────────────────────────────────────────────┤
│  📍 台北 天氣資訊                                   │
│  ┌─────────────────────────────────────────────┐   │
│  │  🌡️ 氣溫: 26.5°C                            │   │
│  │  🌧️ 雨量: 12.3mm                            │   │
│  │  🕐 更新時間: 2025-01-20 10:30:00           │   │
│  └─────────────────────────────────────────────┘   │
│                                                     │
├─────────────────────────────────────────────────────┤
│  🔍 追蹤資訊                                        │
│  ┌─────────────────────────────────────────────┐   │
│  │  Trace ID: abc123def456...  [查看詳情]      │   │
│  │  耗時: 45ms                                  │   │
│  └─────────────────────────────────────────────┘   │
│                                                     │
├─────────────────────────────────────────────────────┤
│  🔗 快速連結                                        │
│  [Jaeger UI]  [Grafana]  [Prometheus]              │
└─────────────────────────────────────────────────────┘
```

#### 3.2.2 互動狀態
| 狀態 | 顯示內容 |
|------|----------|
| 初始 | 顯示三個城市按鈕，天氣區域提示「請選擇城市」 |
| 載入中 | 按鈕禁用，顯示 Loading Spinner |
| 成功 | 顯示天氣資料和 Trace ID |
| 錯誤 | 顯示錯誤訊息，可重試 |

---

## 4. API 規格

### 4.1 查詢天氣 API

#### Request
```
GET /api/weather/{cityCode}
```

#### Path Parameters
| 參數 | 類型 | 必填 | 說明 |
|------|------|------|------|
| cityCode | String | 是 | 城市代碼（TPE/TXG/KHH） |

#### Response Headers
| Header | 說明 |
|--------|------|
| X-Trace-Id | OpenTelemetry Trace ID |
| X-Span-Id | 當前 Span ID |
| X-Request-Duration | 請求處理時間（ms） |

#### Response Body (200 OK)
```json
{
  "success": true,
  "data": {
    "cityCode": "TPE",
    "cityName": "台北",
    "temperature": 26.5,
    "rainfall": 12.3,
    "updatedAt": "2025-01-20T10:30:00Z"
  },
  "traceInfo": {
    "traceId": "abc123def456789...",
    "spanId": "span123...",
    "duration": 45
  }
}
```

#### Response Body (404 Not Found)
```json
{
  "success": false,
  "error": {
    "code": "CITY_NOT_FOUND",
    "message": "找不到指定的城市"
  },
  "traceInfo": {
    "traceId": "abc123def456789...",
    "spanId": "span123...",
    "duration": 5
  }
}
```

### 4.2 健康檢查 API

#### Gateway Health
```
GET /actuator/health
```

#### Weather Service Health
```
GET /api/weather/actuator/health
```

---

## 5. 非功能性需求

### 5.1 效能需求
| 指標 | 目標值 | 說明 |
|------|--------|------|
| 回應時間 | < 200ms (P95) | 單一天氣查詢 |
| 並發使用者 | 10 | PoC 展示用途 |

### 5.2 可觀測性需求（核心）

#### 5.2.1 追蹤（Tracing）需求
- **必須** 能在 Jaeger UI 看到完整的請求鏈路
- **必須** 包含以下 Span：
  1. Frontend → Gateway
  2. Gateway → Weather Service
  3. Weather Service → Database
- **必須** 每個 Span 包含：
  - 操作名稱
  - 開始/結束時間
  - 狀態（成功/失敗）
  - 相關標籤（城市代碼、服務名稱等）

#### 5.2.2 指標（Metrics）需求
- **必須** 在 Grafana 顯示：
  - 請求總數（按服務、端點分組）
  - 請求延遲（P50, P95, P99）
  - 錯誤率
  - JVM 記憶體使用量
  - 資料庫連線池狀態

### 5.3 部署需求
- 支援本機開發模式
- 支援 Docker Compose 一鍵啟動
- 支援 Kubernetes (Kind) 部署
- 提供自動化部署腳本

---

## 6. 成功指標

### 6.1 PoC 展示成功標準
| 檢查項目 | 驗證方式 |
|----------|----------|
| 天氣查詢功能正常 | 三個城市都能查詢並顯示資料 |
| Trace ID 傳遞正確 | 前端顯示的 Trace ID 與 Jaeger 一致 |
| 鏈路追蹤完整 | Jaeger 顯示 Frontend→Gateway→Service→DB 完整鏈路 |
| 指標收集正常 | Grafana 儀表板顯示即時指標 |
| 四種部署模式可用 | 每種模式都能成功啟動並運作 |

### 6.2 展示劇本
1. **開場**：介紹系統架構和可觀測性目標
2. **功能展示**：查詢三個城市的天氣
3. **追蹤展示**：在 Jaeger 中展示請求鏈路
4. **指標展示**：在 Grafana 中展示系統指標
5. **故障模擬**（可選）：模擬延遲/錯誤，觀察追蹤資訊

---

## 7. 術語表

| 術語 | 定義 |
|------|------|
| Trace | 一個完整請求的端到端追蹤記錄 |
| Span | 追蹤中的單一操作單元 |
| Trace ID | 識別整個追蹤的唯一 ID（跨服務一致） |
| Span ID | 識別單一 Span 的唯一 ID |
| Parent Span ID | 父 Span 的 ID，用於建立層級關係 |
| OpenTelemetry | 可觀測性資料收集的開放標準 |
| Jaeger | 分散式追蹤系統 |
| Prometheus | 時序指標資料庫 |
| Grafana | 指標視覺化平台 |

---

## 8. 版本歷史

| 版本 | 日期 | 作者 | 變更說明 |
|------|------|------|----------|
| 1.0 | 2025-01-20 | Architect | 初始版本 |
